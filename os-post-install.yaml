---
- hosts: all
  become: yes
  become_user: root
  become_method: sudo
  remote_user: sys-admin

  vars:
    wazuh_agent_ver: wazuh-agent-4.5.4-1.x86_64.rpm
    wazuh_server: 10.0.14.89
    ipa_srv: itcipa.itcbd.com 
    dom: itcbd.com 
    realm: ITCBD.COM 
    passwd: Mar@Sys@Ipa#03#03
    user: admin

  tasks:
   - name: Get the Active IP Address
     shell: hostname -I
     register: get_ip

   - set_fact:
      IP={{ get_ip.stdout }}
    
   - name: Install Required Packages
     yum:
       name:
        - rsyslog
        - open-vm-tools
        - ipa-client
        - chrony
        - authselect-compat
        - lsof
        - katello-host-tools-tracer
       state: present

   - name: Set DNS for IPA
     lineinfile:
      path: /etc/resolve.conf
      regexp: '^# Generated by NetworkManager'
      replace: |-
        search itcbd.com
        nameserver 10.0.14.18
        nameserver 10.0.14.20

   - name: Set NTP server for IPA
     lineinfile:
      path: /etc/chrony.conf
      regexp: '^(#)?pool'
      replace: |-
        server 10.0.14.46
        server 10.0.14.47
      notify: restart chronyd

   - name: IPA client register
     shell: ipa-client-install --server={{ ipa_srv }} --domain={{ dom }} --realm={{ realm }} -w {{ passwd }} --mkhomedir -N -p {{ user }} -U

   - name: Set rsyslog Server for MZ Block
     lineinfile:
      path: /etc/rsyslog.conf
      regexp: ''
      insertafter: EOF
      line: '*.*     @10.10.11.99:514'
      when: not IP is search("10.0.14.*")        
      notify: restart rsyslog-mz

   - name: Set rsyslog Server for DMZ Block
     lineinfile:
      path: /etc/rsyslog.conf
      regexp: ''
      insertafter: EOF
      line: '*.*     @10.0.14.251:514'
      when: IP is search("10.0.14.*")
      notify: restart rsyslog-dmz

   - name: Copy latest wazuh agent file to target server
     copy: 
       src: /data/files/wazuh/{{ wazuh_agent_ver }} 
       dest: /home/sys-admin/ 
       force: no

   - name: Install wazuh-agent Package
     shell: WAZUH_MANAGER={{ wazuh_server }} yum install {{ wazuh_agent_ver }} -y
     args:
       chdir: /home/sys-admin
     notify: restart wazuh

   - name: Set Password Complexity
     shell: "{{ item }}"
     with_items:
      - authconfig --passminlen=12 --update
      - authconfig --enablereqlower --update
      - authconfig --enablerequpper --update
      - authconfig --enablereqdigit --update
      - authconfig --enablereqother --update
     when: (ansible_facts['distribution'] == "RedHat" and ansible_facts['distribution_major_version'] >= "7")

   - name: Sync with Forman
     shell: /usr/sbin/katello-tracer-upload

   - name: Print NTP Current Value
     debug: 
       msg: "{{ ntp_output.stdout_lines }}"

   - name: Get DNS Current Value
     shell: cat /etc/resolv.conf |grep -v "#"
     register: dns_output

   - name: Print DNS Current Value
     debug:
       msg: "{{ dns_output.stdout_lines }}"

   - name: Get rsyslog Current Value
     shell: cat /etc/rsyslog.conf |grep -v "#"|egrep "10.10.11.99|10.0.14.251"
     register: rsyslog_output

   - name: Print rsyslog Current Value
     debug:
       msg: "{{ rsyslog_output.stdout_lines }}"

   - name: Get FIM server Current Value
     shell: cat /var/ossec/etc/ossec.conf |grep "<address>"
     register: fim_output

   - name: Print FIM server Current Value
     debug:
       msg: "{{ fim_output.stdout_lines }}"

   - name: Get IPA server Current Value
     shell: cat /etc/openldap/ldap.conf | grep -v "#" |grep URI
     register: ipa_output

   - name: Print IPA server Current Value
     debug:
       msg: "{{ ipa_output.stdout_lines }}"
         
  handlers:
   - name: restart chronyd
     action: service name=chronyd state=restarted daemon_reload=yes enabled=yes
   - name: restart rsyslog-mz
     action: service name=rsyslog state=restarted daemon_reload=yes enabled=yes
   - name: restart rsyslog-dmz
     action: service name=rsyslog state=restarted daemon_reload=yes enabled=yes
   - name: restart wazuh
     action: service name=wazuh-agent state=restarted daemon_reload=yes enabled=yes
